# escape=`
FROM mcr.microsoft.com/windows/servercore:ltsc2022 AS downloader

SHELL ["powershell", "-Command", "$ErrorActionPreference = 'Stop'; $ProgressPreference = 'SilentlyContinue';"]

ENV ES_VERSION="25.1.0" `
    ES_HOME="C:\kurrentdb"

# ENV chocolateyUseWindowsCompression false

# RUN powershell -Command `
#         iex ((new-object net.webclient).DownloadString('https://chocolatey.org/install.ps1')); `
#         choco feature disable --name showDownloadProgress

# RUN choco install eventstore-oss
#RUN Invoke-WebRequest "https://github.com/kurrent-io/KurrentDB/releases/download/v25.1.0/kurrentdb-25.1.0-windows-x64.tar.gz" -OutFile 'kurrentdb.zip' -UseBasicParsing; `
tar -xzf kurrentdb.tar.gz -C $env:ES_HOME

FROM mcr.microsoft.com/windows/servercore:ltsc2022
SHELL ["powershell", "-Command", "$ErrorActionPreference = 'Stop';"]

ENV ES_VERSION="25.1.0" `
ES_HOME="C:\kurrentdb" `
DOTNET_RUNNING_IN_CONTAINER=true

EXPOSE 2113

VOLUME C:\Data
VOLUME C:\Logs

RUN New-Item -Path Config -ItemType Directory | Out-Null

WORKDIR $ES_HOME
COPY --from=downloader C:\kurrentdb\ .
COPY eventstore.conf .\Config\kurrentdb.yml


# Run Service
SHELL ["cmd", "/S", "/C"]
CMD "c:\eventstore\EventStore.ClusterNode.exe --db c:\Data --log c:\Logs --config=C:\eventstore\Config\eventstore.conf"
