FROM eventstore/eventstore:21.10.0-bionic AS base

FROM eventstore/es-gencert-cli:1.0.2 AS build

WORKDIR /app

RUN mkdir -p ./certs 
WORKDIR /app/certs

RUN es-gencert-cli create-ca
RUN es-gencert-cli create-node -out ./node1 -ip-addresses 127.0.0.1 -dns-names localhost
RUN find . -type f -print0 | xargs -0 chmod 666

FROM build AS publish
FROM base AS final
WORKDIR /app
COPY --from=publish /app/certs /certs

ENTRYPOINT ["/opt/eventstore/EventStore.ClusterNode"]